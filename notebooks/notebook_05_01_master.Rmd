---
title: "Week Five, Class One"
format: html
---

For our first example, we will continue using data from Chetty et al's 2014 paper "Where Is The Land Of Opportunity?". The `commuting_zones.csv` file on Canvas comes from the Opportunity Insights website which can be accessed [`here`](http://www.opportunityinsights.org).

Load the data as a data frame called `cz` and load tidyverse.

```{r, warning = FALSE, error = FALSE, message = FALSE}
library(tidyverse)

cz <- read.csv("https://raw.githubusercontent.com/mjclawrence/soci385_f23/main/data/commuting_zones.csv")
```

We'll look at a small subset of the data to start so let's pull the following variables into a new data frame called `cz_subset`: 

- `mobility` = measure of absolute upward mobility
- `gini` = Gini coefficient of income inequality; higher gini values indicate more inequality
- `urban` = binary variable for urban (1) or rural (0) commuting zone
- `hh_income` = median household family income in commuting zone
- `racial_seg` = measure of racial segregation

```{r create subset}
cz_subset <- cz |>
     select(mobility, gini, urban, hh_income, racial_seg)
```


# Correlation Matrix

One way to save some time when looking at multiple correlations is to create a matrix with all the possible correlations in your dataframe. 

```{r create matrix}
matrix <- round(cor(cz_subset, use = "complete.obs"),3) 
```

Let's review the matrix!

```{r review matrix}
matrix
```

Options exist for visualizing correlation matrices. The heatmaps in the GGally package are particularly effective.

```{r}
#install.packages("GGally") # hashtag this line after installing
library(GGally)
```

Use the `ggcorr()` function to build the matrix. For best results, add the options `label = TRUE` (to include the correlation coefficient label) and `label_round = 3` (to round the coefficient to 3 decimal places). 

```{r}
ggcorr(cz_subset, method = "complete",
       label = TRUE, label_round = 3)
```


# Introducing Multivariate Relationships - See Slides

Last week we identified individual points on a scatterplot to dig deeper into how two variables are associated. Another analytical tool is to examine whether the association differs at specific values of another variable.

Consider the correlation between racial segregation and household income across commuting zones. Would you expect this correlation to be positive or negative? Strong or weak?

### REPLACE THIS LINE WITH YOUR CODE

```{r cor racial segregation and income}
cor(cz_subset$hh_income, cz_subset$racial_seg, 
    use = "complete")
```

Would this association be the same in urban and rural commuting zones?

### REPLACE THIS LINE WITH YOUR CODE

```{r}
cz_urban <- cz_subset |>
  filter(urban==1)

cor(cz_urban$hh_income, cz_urban$racial_seg, use = "complete")
```

```{r}
cz_rural <- cz_subset |> 
  filter(urban==0)

cor(cz_rural$hh_income, cz_rural$racial_seg, use = "complete")
```

```{r cor racial segregation and income by urban}
cor(cz_subset$racial_seg[cz_subset$urban==0], 
    cz_subset$hh_income[cz_subset$urban==0], 
    use = "complete")

cor(cz_subset$racial_seg[cz_subset$urban==1], 
    cz_subset$hh_income[cz_subset$urban==1], 
    use = "complete")
```


```{r}
#| label: urban rural plot
cz_subset <- cz_subset |> 
     mutate(urban = factor(urban, 
                           levels=c("0", "1"), 
                           labels=c("Rural", "Urban")))

urban_rural_plot <- ggplot(cz_subset, aes(x = hh_income, 
                                          y = racial_seg,
                                          color = urban,
                                          shape = urban))

urban_rural_plot + geom_point() + 
  scale_x_continuous(labels = scales::dollar_format()) +
  facet_grid(.~urban) + 
  geom_smooth(method = "lm")
```


## Working With Lots Of Correlations

Let's move to a different example. Consider the relationship between Covid vaccination rates and eviction rates across zip codes. Would you expect a positive or negative association? How strong?

Load the data in a dataset called `evictions`:

```{r}
evictions <- read_csv("../data/eviction_socius.csv")
```


The dataset comes from the Eviction Lab and was provided by Olivia Jin, Middlebury alum and lead author of this paper:

Jin, Olivia, Emily Lemmerman, Peter Hepburn, and Matthew Desmond. 2021. "Neighborhoods with the Highest Eviction Filing Rates Have the Lowest Levels of COVID-19 Vaccination." *Socius* 7: 1-3.

What is the overall correlation between eviction rate (`evict_pct`) and vaccination rate (`vax_pct`)?

```{r}
cor(evictions$evict_pct, evictions$vax_pct,
    use = "complete")
```

Now try using `group_by()` and `summarise()` to find how this association varies across the nine cities the researchers studied.

### REPLACE THIS LINE WITH YOUR CODE CHUNK ###

```{r}
evictions |> 
  filter(evict_pct < 1) |> 
  group_by(xsite) |> 
  summarise(cor = cor(evict_pct, vax_pct,
                      use = "complete"))
```

We can visualize these associations using separate scatterplots for each city. What are some different options for how to do that?

```{r}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point()
```

```{r}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point() + facet_grid(xsite~.)
```

The `facet_wrap()` option is another way to create separate plots for different categories.

```{r}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point() + facet_wrap(~xsite)
``` 

By default, `facet_wrap()` assigns each plot the same x-axis range and the same y-axis range. You can adjust them by adjusting the scales option with "free_x", "free_y" or "free" (for both the x and y axes):

```{r}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point() + facet_wrap(~xsite, scales = "free")
```

How else to improve this figure?

```{r}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point() + facet_wrap(~xsite, scales = "free") +
  guides(color = "none") + geom_smooth(method = "lm")
```


# Some Thoughts About Color

One popular package to use for adjusting color is the R Color Brewer package. You can install it and load it here:

```{r}
#install.packages("RColorBrewer")
library(RColorBrewer)
```

There's good information on Brewer's color options at [this site](http://colorbrewer2.org/#type=diverging&scheme=RdYlGn&n=3).

The site previews options for sequential (or continuous) variables and divergent (or factor/categorical/discrete) variables. Once you find a color scheme you like, input the palette name into the `scale_color_brewer()` function or the `scale_fill_brewer()` function.

```{r}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point() + facet_wrap(~xsite, scales = "free") +
  guides(color = "none") + geom_smooth(method = "lm") +
  scale_color_brewer(palette = "Set1") # Palette Name
```

Want other colors? I like the [`viridis color palettes`](https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html) which we saw last week.

```{r facet plot with viridis palette}
evictions |> 
  ggplot(aes(x = evict_pct, y = vax_pct,
             color = xsite)) +
  geom_point() + facet_wrap(~xsite, scales = "free") +
  guides(color = "none") + geom_smooth(method = "lm") +
  scale_color_viridis_d(option = "mako") # Palette Name
```